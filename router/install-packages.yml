---
- name: Install base packages for router
  hosts: router
  gather_facts: yes
  become: yes

  tasks:
  - name: Repository setup
    block:

    - name: Add Debian buster-backports
      ansible.builtin.lineinfile:
        create: yes
        state: present
        mode: u=rw,g=,o=
        path: /etc/apt/sources.list.d/buster-backports.list
        line: "deb http://deb.debian.org/debian buster-backports main"

    - name: Add Cloudsmith Kea GPG Key
      ansible.builtin.apt_key:
        url: https://dl.cloudsmith.io/public/isc/kea-1-9/gpg.5DC67B0A74E30739.key
        state: present

    - name: Add Cloudsmith Kea repo
      ansible.builtin.lineinfile:
        create: yes
        state: present
        mode: u=rw,g=,o=
        path: /etc/apt/sources.list.d/isc-kea-1-9.list
        line: "deb https://dl.cloudsmith.io/public/isc/kea-1-9/deb/debian buster main"
      
    - name: Add FRRouting GPG key
      ansible.builtin.apt_key:
        url: https://deb.frrouting.org/frr/keys.asc
        state: present
    
    - name: Add FFrouting repo
      ansible.builtin.lineinfile:
        create: yes
        state: present
        mode: u=rw,g=,o=
        path: /etc/apt/sources.list.d/frr-stable.list
        line: "deb https://deb.frrouting.org/frr {{ ansible_distribution_release }} frr-stable"

  - name: Apt update, upgrades, install
    block:
    - name: Upgrades packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: full
    
    - name: Upgrade Kernel Version
      ansible.builtin.apt:
        state: present
        default_release: buster-backports
        name: 
          - linux-image-5.10.0-0.bpo.3-amd64
          - linux-headers-5.10.0-0.bpo.3-amd64
    
    - name: Install base packages from buster-backports
      ansible.builtin.apt:
        state: present
        default_release: buster-backports
        name:
          - nftables
          - wireguard-tools
          - wireguard-dkms
          - unbound
      

    - name: Install base packages
      ansible.builtin.apt:
        state: present
        default_release: buster
        name:
          - sshguard
          - dnsutils
          - debian-keyring
          - debian-archive-keyring
          - apt-transport-https
          - ifenslave
      
    - name: Install custom repo packages
      ansible.builtin.apt:
        state: present
        name:
          - frr
          - frr-pythontools
          - isc-kea-dhcp4-server
          - isc-kea-dhcp6-server
      
  - name: Reboot
    reboot: