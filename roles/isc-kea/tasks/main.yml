---
- name: Install and configuration of isc-Kea
  block:

  - name: Add Cloudsmith Kea GPG Key
    ansible.builtin.apt_key:
      url: https://dl.cloudsmith.io/public/isc/{{ kea_version }}/gpg.5DC67B0A74E30739.key 
      # Hardcoded URL due to variable gpg keyname{ kea-1-9 }, TODO: Add regardless of the name gpg.*.key
      state: present
  
  - name: Add Cloudsmith isc-Kea Debian Repository
    ansible.builtin.apt_repository:
      repo: deb https://dl.cloudsmith.io/public/isc/{{ kea_version }}/deb/debian {{ ansible_distribution_release }}  main
      filename: isc-{{ kea_version }}
      state: present

  - name: Install isc-Kea dhcp server (IPv4 only (for now))
    ansible.builtin.apt:
      name:
        - isc-kea-dhcp4-server
        - isc-kea-admin
        - isc-kea-doc
      update_cache: yes
      state: present

    
    # TODO: Use the template module to add pools, ip reservations etc...
  - name: Configure isc-Kea-dhcp4-server
    ansible.builtin.copy:
      src: kea-dhcp4.conf
      dest: /etc/kea/kea-dhcp4.conf
      owner: root
      group: root
      mode: u=rw,g=r,o=r
      force: yes
    register: kea_config_result
  
  - name: Restart isc-Kea-dhcp4-server service
    ansible.builtin.service:
      name: isc-kea-dhcp4-server.service
      enabled: yes
      state: restarted
    when: kea_config_result.changed | bool == true