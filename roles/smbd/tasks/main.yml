---
- name: Install samba server
  ansible.builtin.apt:
    name: samba
    state: present
  notify: [Enable smbd service, Start smbd service]

- name: Disable nmbd systemd service
  ansible.builtin.systemd:
    name: nmbd.service
    masked: yes
    state: stopped

- name: Configure samba server
  ansible.builtin.template:
    src: "smb.conf.j2"
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  notify: Restart smbd service

- name: Create samba users
  ansible.builtin.user:
    name: "{{ item.username }}"
    create_home: no
    comment: Samba created by Ansible
    password: "!" # Disabled account
    state: present
  when: item.username != primary_user_username
  loop: "{{ samba_server_users }}"
  loop_control:
    label: "{{ item.username }}"

- name: Set samba users passwords
  ansible.builtin.shell:
    cmd: "set -o nounset -o pipefail -o errexit && \
      (pdbedit --user={{ item.username }} 2>&1 > /dev/null) \
      || (echo {{ item.password }}; echo {{ item.password }}) \
      | smbpasswd -s -a {{ item.username }}"
    executable: /bin/bash
  loop: "{{ samba_server_users }}"
  register: create_samba_user_output
  changed_when: "'Added user' in create_samba_user_output.stdout"
  loop_control:
    label: "{{ item.username }}"

- name: Open samba firewalld port
  ansible.posix.firewalld:
    zone: "{{ firewalld_zone }}"
    port: 445/tcp
    permanent: yes
    immediate: yes
    state: enabled