---
- name: Create home_assistant volumes dir
  ansible.builtin.file:
    path: "{{ homeassistant_volumes_path }}"
    state: directory
  # No owner, group or mode becose it cause an error on a nfs share
  # Create it before docker try to handle it, permission error

- name: Run home_assistant docker container
  community.docker.docker_container:
    name: homeassistant_ansible
    image: ghcr.io/home-assistant/raspberrypi4-homeassistant:{{ homeassistant_image_version }}
    ports: "{{ homeassistant_ports }}"
    volumes: "{{ homeassistant_volume }}"
    restart_policy: unless-stopped
    state: started
    privileged: yes
    container_default_behavior: no_defaults

- name: Open firewalld ports
  ansible.posix.firewalld:
    zone: "{{ firewalld_zone }}"
    port: "{{ homeassistant_firewalld_ports }}"
    permanent: yes
    state: enabled
    immediate: yes
  when: ansible_host in grp_firewalld_based_device