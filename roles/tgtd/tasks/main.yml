---
- include_tasks: variables.yml

- include_tasks: debian_setup.yml
  when: ansible_os_family == 'Debian'

- include_tasks: redhat_setup.yml
  when: ansible_os_family == 'RedHat'

- name: Config iscsi targets
  ansible.builtin.template:
    src: tgt.conf.j2
    dest: "/etc/tgt/conf.d/{{ item.iqn }}.conf"
    owner: root
    group: root
    mode: u=rw,g=r,o=
  loop: "{{ host_iscsi_targets }}"
  loop_control:
    label: "iSCSI Target: {{ item.iqn }}"
  notify: Restart tgt service

- name: Open iscsi-target firewalld service
  ansible.posix.firewalld:
    zone: "{{ firewalld_zone }}"
    service: iscsi-target
    permanent: yes
    immediate: yes
    state: enabled