---
- name: Add zrepl repo key
  ansible.builtin.apt_key:
    url: https://zrepl.cschwarz.com/apt/apt-key.asc
    state: present

- name: Add zrepl debian source repo
  ansible.builtin.apt_repository:
    repo: deb [arch={{ cpu_architecture }}] https://zrepl.cschwarz.com/apt/{{ ansible_os_family | lower }} {{ ansible_distribution_release }} main
    state: present
    filename: zrepl

- name: Install zrepl package
  ansible.builtin.apt:
    name: zrepl
    state: present
    update_cache: yes

- name: Disable upgrade of zrepl ( breaking changes )
  ansible.builtin.dpkg_selections:
    name: zrepl
    selection: hold

- name: Configure zrepl
  ansible.builtin.template:
    src: zrepl.yml.j2
    dest: /etc/zrepl/zrepl.yml
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  notify: Enable & Restart zrepl service
