---
- name: Create transmission volumes dir
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: emanon
    group: emanon
    mode: u=rwx,g=,o=
  loop: "{{ podman_transmission_directories }}"

- name: Run transmission podman container
  containers.podman.podman_container:
    name: transmission_ansible
    image: "{{ podman_transmission_image }}:{{ podman_transmission_image_version }}"
    publish: "{{ podman_transmission_ports }}"
    volumes: "{{ podman_transmission_volumes }}"
    log_driver: k8s-file
    log_options: max_size=10m
    restart_policy: unless-stopped
    state: started
    privileged: yes
    env:
      OPENVPN_PROVIDER: "{{ podman_transmission_openvpn_provider }}"
      OPENVPN_CONFIG: "{{ podman_transmission_openvpn_config }}"
      OPENVPN_USERNAME: "{{ podman_transmission_openvpn_username }}"
      OPENVPN_PASSWORD: "{{ podman_transmission_openvpn_password }}"
      LOCAL_NETWORK: "192.168.0.0/16"
      TRANSMISSION_HOME: "/transmission/home"
      TRANSMISSION_DOWNLOAD_DIR: "/media"
      #TRANSMISSION_INCOMPLETE_DIR: "/transmission/incompleted"
      TRANSMISSION_WATCH_DIR: "/transmission/watch"
      TRANSMISSION_WEB_UI: "flood-for-transmission"
  become_user: "{{ primary_user_username }}"

- name: Open transmission firewalld ports
  ansible.posix.firewalld:
    zone: "{{ podman_transmission_firewalld_zone }}"
    port: "{{ podman_transmission_firewalld_ports }}"
    permanent: yes
    immediate: yes
    state: enabled
  when:
    - podman_networking.transmission.lan_access is defined
    - podman_networking.transmission.lan_access
    - ansible_host == 'pi.local.emanon'

- name: Close transmission firewalld ports
  ansible.posix.firewalld:
    zone: "{{ podman_transmission_firewalld_zone }}"
    port: "{{ podman_transmission_firewalld_ports }}"
    permanent: yes
    immediate: yes
    state: disabled
  when:
    - podman_networking.transmission.lan_access is defined
    - not podman_networking.transmission.lan_access
    - ansible_host == 'pi.local.emanon'

- name: Open transmission firewalld ports to admin devices
  ansible.posix.firewalld:
    zone: "{{ podman_transmission_firewalld_zone }}"
    rich_rule: "rule family={{ item.familly }} source address={{ item.source }} port port={{ podman_transmission_firewalld_ports }} protocol=tcp accept"
    permanent: yes
    immediate: yes
    state: enabled
  loop:
    - { familly: "ipv4", source: "{{ grp_device.arch.ipv4_addr }}" }
    - { familly: "ipv4", source: "{{ grp_device.one.ipv4_addr }}" }
    - { familly: "ipv6", source: "{{ grp_device.arch.ipv6_addr_global }}" }
    # - { familly: "ipv6", source: "{{ grp_device.arch.ipv6_addr_link }}" }
  when:
    - podman_networking.transmission.lan_access is defined
    - podman_networking.transmission.lan_access
    - ansible_host == 'lain.emanon.moe'

- name: Close transmission firewalld ports to admin devices
  ansible.posix.firewalld:
    zone: "{{ podman_transmission_firewalld_zone }}"
    rich_rule: "rule family={{ item.familly }} source address={{ item.source }} port port={{ podman_transmission_firewalld_ports }} protocol=tcp accept"
    permanent: yes
    immediate: yes
    state: disabled
  loop:
    - { familly: "ipv4", source: "{{ grp_device.arch.ipv4_addr }}" }
    - { familly: "ipv4", source: "{{ grp_device.one.ipv4_addr }}" }
    - { familly: "ipv6", source: "{{ grp_device.arch.ipv6_addr_global }}" }
    # - { familly: "ipv6", source: "{{ grp_device.arch.ipv6_addr_link }}" }
  when:
    - podman_networking.transmission.lan_access is defined
    - not podman_networking.transmission.lan_access
    - ansible_host == 'lain.emanon.moe'