---
- name: Install ansible
  ansible.builtin.apt:
    name: ansible
    state: present

- name: Pull latest source files from github
  ansible.builtin.git:
    repo: https://github.com/EmanonUser/Ansible-EmanonLab
    dest: Ansible-EmanonLab
    single_branch: yes
    version: main
    force: yes

- name: Place ansible vault password file
  ansible.builtin.lineinfile:
    path: .VAULT_PASS
    line: "{{ grp_vault_password }}"
    owner: ansible
    group: ansible
    mode: u=r,g=,o=
    create: yes
    state: present

- name: Install collections from requirements.yml
  community.general.ansible_galaxy_install:
    type: collection
    requirements_file: /home/ansible/Ansible-EmanonLab/requirements.yml
    dest: /home/ansible/.ansible/collections/ansible_collections/

- name: Place ansible_acme_renew systemd files
  ansible.builtin.template:
    src: "ansible_acme_renew.{{ item }}.j2"
    dest: "/etc/systemd/system/ansible_acme_renew.{{ item }}"
    owner: root
    group: root
    mode: u=rw,g=,o=
  loop: ["service", "timer"]
  notify:
    - Daemon-reload acme_dns systemd
    - Enable ansible_acme_renew timer
    - Start ansible_acme_renew timer