---
- name: Create transmission volumes dir
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: emanon
    group: emanon
    mode: u=rwx,g=,o=
  loop: "{{ transmission_directories }}"
  become_user: "{{ primary_user_username }}"

- name: Run transmission podman container
  containers.podman.podman_container:
    name: transmission
    image: "{{ transmission_image }}:{{ transmission_image_version }}"
    publish: "{{ transmission_ports }}"
    volumes: "{{ transmission_volumes }}"
    network: "{{ transmission_network }}"
    timezone: Europe/Paris
    log_driver: k8s-file
    log_options: max_size=10m
    state: started
    privileged: true
    user: root
    label:
      io.containers.autoupdate: registry
      PODMAN_SYSTEMD_UNIT: container-transmission.service
    security_opt: label=disable
    generate_systemd:
      new: true
      path: /home/{{ primary_user_username }}/.config/systemd/user/
    env:
      TRANSMISSION_RPC_USERNAME: "{{ transmission_env_rpc_username }}"
      TRANSMISSION_RPC_PASSWORD: "{{ transmission_env_rpc_password }}"
      TRANSMISSION_RPC_AUTHENTICATION_REQUIRED: "{{ transmission_env_rpc_auth_required }}"
      OPENVPN_PROVIDER: "{{ transmission_env_openvpn_provider }}"
      OPENVPN_CONFIG: "{{ transmission_env_openvpn_config }}"
      OPENVPN_USERNAME: "{{ transmission_env_openvpn_username }}"
      OPENVPN_PASSWORD: "{{ transmission_env_openvpn_password }}"
      TRANSMISSION_HOME: "{{ transmission_env_home_path }}"
      TRANSMISSION_DOWNLOAD_DIR: "{{ transmission_env_download_path }}"
      TRANSMISSION_INCOMPLETE_DIR: "{{ transmission_env_incomplete_path }}"
      TRANSMISSION_WATCH_DIR: "{{ transmission_env_watch_path }}"
      TRANSMISSION_WEB_UI: "{{ transmission_env_web_ui }}"
      LOCAL_NETWORK: "{{ transmission_env_local_network }}"
      CREATE_TUN_DEVICE: "yes"
  become_user: "{{ primary_user_username }}"
  notify: Enable transmission service

- name: Import firewalld tasks rules handling
  ansible.builtin.include_tasks:
    file: firewalld.yml
  when: podman_use_firewalld
