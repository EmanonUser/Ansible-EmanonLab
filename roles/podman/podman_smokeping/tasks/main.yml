---
- name: Create smokeping volume directory
  ansible.builtin.file:
    path: "{{ item }}"
    owner: emanon
    group: emanon
    mode: u=rwx,g=,o=
    state: directory
  loop: "{{ podman_smokeping_directories }}"

- name: Set sysctl value to allow pinging
  ansible.builtin.sysctl:
    name: net.ipv4.ping_group_range
    value: "0 2000"
    reload: yes
    state: present

- name: Run smokeping podman container
  containers.podman.podman_container:
    name: smokeping_ansible
    image: "{{ podman_smokeping_image }}:{{ podman_smokeping_image_version }}"
    publish: "{{ podman_smokeping_ports }}"
    volume: "{{ podman_smokeping_volumes }}"
    restart_policy: unless-stopped
    state: started
    generate_systemd:
      container_prefix: podman
      path: /home/{{ primary_user_username }}/.config/systemd/user/
    env:
      TZ: "Europe/Paris"
  become_user: "{{ primary_user_username }}"
  notify: Enable smokeping_ansible podman service

- name: Open smokeping firewalld ports
  ansible.posix.firewalld:
    zone: "{{ podman_smokeping_firewalld_zone }}"
    port: "{{ podman_smokeping_firewalld_ports }}"
    permanent: yes
    immediate: yes
    state: enabled
  when: podman_networking.smokeping.lan_access

- name: Close smokeping firewalld ports
  ansible.posix.firewalld:
    zone: "{{ podman_smokeping_firewalld_zone }}"
    port: "{{ podman_smokeping_firewalld_ports }}"
    permanent: yes
    immediate: yes
    state: disabled
  when: not podman_networking.smokeping.lan_access
