---
- name: Create syncthing directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: emanon
    group: emanon
    mode: u=rwx,g=,o=
  loop: "{{ syncthing_directories }}"
  become_user: "{{ primary_user_username }}"

- name: Run syncthing podman container
  containers.podman.podman_container:
    name: syncthing
    image: "{{ syncthing_image }}:{{ syncthing_image_version }}"
    publish: "{{ syncthing_ports }}"
    volumes: "{{ syncthing_volumes }}"
    network: "{{ syncthing_network }}"
    timezone: Europe/Paris
    state: present
    user: root
    label:
      io.containers.autoupdate: registry
      PODMAN_SYSTEMD_UNIT: container-syncthing.service
    security_opt: label=disable
    generate_systemd:
      new: true
      path: /home/{{ primary_user_username }}/.config/systemd/user/
    env:
      PUID: "0"
      PGID: "0"
      TZ: Europe/Paris
  become_user: "{{ primary_user_username }}"
  notify:
    - Reload systemd daemon 
    - Enable syncthing service
    - Stop syncthing service
    - Start syncthing service

- name: Import firewalld tasks
  ansible.builtin.include_tasks:
    file: firewalld.yml
  when: podman_use_firewalld
