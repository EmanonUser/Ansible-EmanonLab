---
- name: Create grafana volume directories
  ansible.builtin.file:
    path: "{{ item }}"
    owner: emanon
    group: emanon
    mode: u=rwx,g=,o=
    state: directory
  loop: "{{ grafana_directories }}"
  become_user: "{{ primary_user_username }}"

- name: Run grafana podman container
  containers.podman.podman_container:
    name: grafana_ansible
    image: "{{ grafana_image }}:{{ grafana_image_version }}"
    volumes: "{{ grafana_volumes }}"
    publish: "{{ grafana_ports }}"
    network: "{{ grafana_network }}"
    restart_policy: unless-stopped
    state: started
    user: root
    label: io.containers.autoupdate=image
    security_opt: label=disable
    generate_systemd:
      container_prefix: podman
      path: /home/{{ primary_user_username }}/.config/systemd/user/
    env:
      GF_SECURITY_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
  become_user: "{{ primary_user_username }}"
  notify: Enable grafana_ansible podman service

- name: Import firewalld tasks
  include_tasks: firewalld.yml
  when: podman_use_firewalld