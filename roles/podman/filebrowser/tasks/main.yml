---
- name: Create filebrowser dir(s)
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: emanon
    group: emanon
    mode: u=rwx,g=,o=
  loop: "{{ filebrowser_directories }}"

- name: Import filebrowser base config
  ansible.builtin.copy:
    src: settings.json
    dest: "{{ filebrowser_files.config }}"
    owner: "{{ primary_user_username }}"
    group: "{{ primary_user_username }}"
    mode: u=rw,g=,o=
    force: false

- name: Create filebrowser empty database
  ansible.builtin.copy:
    content: ""
    dest: "{{ filebrowser_files.database }}"
    owner: "{{ primary_user_username }}"
    group: "{{ primary_user_username }}"
    mode: u=rw,g=,o=
    force: false

- name: Run filebrowser podman container
  containers.podman.podman_container:
    name: filebrowser
    image: "{{ filebrowser_image }}:{{ filebrowser_image_version }}"
    publish: "{{ filebrowser_ports }}"
    volumes: "{{ filebrowser_volumes }}"
    network: "{{ filebrowser_network }}"
    timezone: Europe/Paris
    state: present
    user: root
    generate_systemd:
      new: true
      path: /home/{{ primary_user_username }}/.config/systemd/user/
      env:
        PUID: "1000"
        PGID: "1000"
  become_user: "{{ primary_user_username }}"
  notify:
    - Reload systemd daemon
    - Enable filebrowser service
    - Stop filebrowser service
    - Start filebrowser service

- name: Import firewalld tasks
  ansible.builtin.include_tasks:
    file: firewalld.yml
  when: podman_use_firewalld
