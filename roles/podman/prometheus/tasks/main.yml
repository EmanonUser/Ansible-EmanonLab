---
- name: Create prometheus volume directory
  ansible.builtin.file:
    path: "{{ item }}"
    owner: "{{ primary_user_username }}"
    group: "{{ primary_user_username }}"
    mode: u=rwx,g=,o=
    state: directory
  loop: "{{ prometheus_directories }}"
  become_user: "{{ primary_user_username }}"

- name: Configure prometheus TSDB
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ prometheus_config_path }}"
    owner: "{{ primary_user_username }}"
    group: "{{ primary_user_username }}"
    mode: u=rwx,g=,o=
  register: conf_change
  become_user: "{{ primary_user_username }}"

- name: Run prometheus podman container
  containers.podman.podman_container:
    name: prometheus_ansible
    image: "{{ prometheus_image }}:{{ prometheus_image_version }}"
    publish: "{{ prometheus_ports }}"
    volume: "{{ prometheus_volumes }}"
    network: "{{ prometheus_network }}"
    restart_policy: unless-stopped
    state: started
    recreate: "{% if conf_change.changed %}yes{% else %}no{% endif %}"
    label: io.containers.autoupdate=image
    user: root # Overwrite the nobody user in the Dockerfile
    security_opt: label=disable
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/etc/prometheus/data"
      - "--storage.tsdb.retention=1y"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
    generate_systemd:
      container_prefix: podman
      path: /home/{{ primary_user_username }}/.config/systemd/user/
  become_user: "{{ primary_user_username }}"
  notify: Enable prometheus_ansible podman service

- name: Import firewalld tasks
  include_tasks: firewalld.yml
  when: podman_use_firewalld