---
- name: Create adguard volumes directories
  ansible.builtin.file:
    path: "{{ item }}"
    owner: emanon
    group: emanon
    mode: u=rwx,g=,o=
    state: directory
  loop: "{{ adguard_directories }}"
  become_user: "{{ primary_user_username }}"

- name: Run adguard podman container
  containers.podman.podman_container:
    name: adguard
    image: "{{ adguard_image }}:{{ adguard_image_version }}"
    publish: "{{ adguard_ports }}"
    volume: "{{ adguard_volumes }}"
    network: "{{ adguard_network }}"
    state: started
    label:
      io.containers.autoupdate: registry
      PODMAN_SYSTEMD_UNIT: container-adguard.service
    user: root
    security_opt: label=disable
    generate_systemd:
      path: /home/{{ primary_user_username }}/.config/systemd/user/
  become_user: "{{ primary_user_username }}"
  notify:
    - Reload adguard systemd daemon
    - Enable adguard service
    - Stop adguard service
    - Start adguard service

- name: Import firewalld tasks
  include_tasks: firewalld.yml
  when: podman_use_firewalld
