---
- name: Create promtail volume directory
  ansible.builtin.file:
    path: "{{ item }}"
    owner: "{{ primary_user_username }}"
    group: "{{ primary_user_username }}"
    mode: u=rwx,g=,o=
    state: directory
  loop: "{{ podman_promtail_directories }}"

- name: Configure promtail config file
  ansible.builtin.template:
    src: promtail-config.yml.j2
    dest: "{{ podman_promtail_config_path }}"
    owner: "{{ primary_user_username }}"
    group: "{{ primary_user_username }}"
    mode: u=rw,g=,o=

- name: Run promtail podman container
  containers.podman.podman_container:
    name: promtail_ansible
    image: "{{ podman_promtail_image }}:{{ podman_promtail_image_version }}"
    volume: "{{ podman_promtail_volumes }}"
    restart_policy: unless-stopped
    state: started
    command:
      - "-config.file=/mnt/config/promtail-config.yml"
    generate_systemd:
      container_prefix: podman
      path: /home/{{ primary_user_username }}/.config/systemd/user/
  become_user: "{{ primary_user_username }}"
  notify: Enable promtail_ansible podman service