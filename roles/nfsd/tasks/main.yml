---
- include_tasks: debian_setup.yml
  when: ansible_os_family == 'Debian'

- include_tasks: redhat_setup.yml
  when: ansible_os_family == 'RedHat'

- name: Create exports root dir
  ansible.builtin.file:
    path: "/srv/nfs4"
    owner: "{{ primary_user_username }}"
    group: "{{ primary_user_username }}"
    mode: u=rwx,g=,o=
    state: directory

- name: Create export dir(s)
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: "{{ primary_user_username }}"
    group: "{{ primary_user_username }}"
    mode: u=rwx,g=,o=
    state: directory
  when: item.export != 'root'
  loop: "{{ host_nfs_exports }}"
  loop_control:
    label: "NFS Export: {{ item.path }}"

- name: Create bind mount to zfs dataset(s)
  ansible.posix.mount:
    path: "{{ item.path }}"
    src: "{{ item.export }}"
    opts: bind
    state: mounted
    fstype: zfs
  when: item.export != 'root'
  loop: "{{ host_nfs_exports }}"
  loop_control:
    label: "Bind mount: {{ item.export }}  -->   {{ item.path }}"

- name: Configure NFSv4 exports
  ansible.builtin.template:
    src: exports.j2
    dest: /etc/exports
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  notify: Restart nfs-server service

- name: Open NFSv4 firewalld service
  ansible.posix.firewalld:
    zone: "{{ firewalld_zone }}"
    service: nfs
    permanent: yes
    immediate: yes
    state: enabled