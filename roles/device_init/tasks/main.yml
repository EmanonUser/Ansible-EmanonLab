---
- name: Add primary user
  ansible.builtin.user:
    name: "{{ primary_user_username }}"
    create_home: yes
    shell: /usr/bin/bash
    comment: Primary user created by Ansible
    password: "{{ primary_user_password | password_hash('sha512') }}"
    state: present
  when: create_user

- name: Create SSH dir for primary user
  ansible.builtin.file:
    path: /home/{{ primary_user_username }}/.ssh/
    owner: "{{ primary_user_username }}"
    group: "{{ primary_user_username }}"
    mode: u=rwx,g=,o=
    state: directory

- name: Add SSH key to primary user
  ansible.posix.authorized_key:
    user: "{{ primary_user_username }}"
    key: "{{ primary_user_ssh_pubkey }}"
    state: present

- name: Add primary user to sudoers
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    line: "{{ primary_user_username }} ALL=(ALL:ALL) ALL"
    state: present
    validate: /usr/sbin/visudo -cf %s

- name: Set system-wide umask
  ansible.builtin.copy:
    content: umask 0077
    dest: /etc/profile.d/umask.sh
    owner: root
    group: root
    mode: u=rw,g=,o=

- name: Check if debian-backports.list exist
  ansible.builtin.stat:
    path: /etc/apt/sources.list.d/buster-backports.list
  register: value

- name: Add debian-backports repository
  ansible.builtin.apt_repository:
    repo: deb http://deb.debian.org/debian {{ ansible_distribution_release }}-backports main
    filename: "{{ ansible_distribution_release }}-backports"
    state: present
  when: not value.stat.exists

- name: Update repository & Upgrade packages
  ansible.builtin.apt:
    update_cache: yes
    upgrade: yes
