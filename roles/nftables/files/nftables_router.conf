#!/usr/sbin/nft -f

flush ruleset

define WAN = enp1s0
define LAN = bond0
define WG = wg0

table ip routing {
	chain prerouting {
		type nat hook prerouting priority dstnat; policy accept
		iifname $WAN udp dport 2000 redirect to :51820 # Wiregard server DNAT
		iifname $WAN tcp dport 22000 dnat to 192.168.10.30:22000 # Syncthing DNAT
		iifname $WAN tcp dport 8000 dnat to 192.168.20.20:8000 # Temporary web server DNAT
	}
	chain postrouting {
		type nat hook postrouting priority srcnat; policy accept
		oifname $WAN masquerade # WAN NAT
		iifname $WG ip saddr 176.16.0.0/24 oifname $LAN masquerade # Wireguard NAT
	}
}

table inet firewall {
	
	set RFC1918_3330v4 {
		type ipv4_addr
		counter
		flags interval
		elements = { 
		10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 0.0.0.0/8, 14.0.0.0/8,
		24.0.0.0/8, 39.0.0.0/8, 127.0.0.0/8, 128.0.0.0/16, 169.254.0.0/16, 191.255.0.0/16,
		192.0.0.0/24, 192.0.2.0/24, 192.88.99.0/24, 198.18.0.0/15, 223.255.255.0/24, 
		224.0.0.0/4, 240.0.0.0/4
		}
	}


	chain input {
		type filter hook input priority filter; policy drop;

		ct state invalid counter drop
		icmp type echo-request icmp sequence 21 log level notice prefix "Lain Server KeepAlive Ping: " counter accept # Keepalive Ping from lain every 15m
		iifname $LAN ip saddr 192.168.5.2 ip id 89 counter accept # OSPF, accept all from brocade
		ct state { established, related } counter accept
		iifname { "lo" } accept
		iifname { "lo" } ip saddr != 127.0.0.0/8 counter drop
		ip protocol icmp counter accept
		ip6 nexthdr icmpv6 counter accept
		icmpv6 type { echo-request, nd-neighbor-solicit, nd-neighbor-advert } accept
		icmpv6 type { nd-router-solicit, nd-router-advert, mld-listener-query } accept
		
		iifname $LAN ip saddr 192.168.5.2 counter accept # OSPF, accept all from brocade
		
		iifname $LAN udp dport { 53, 67, 123 } counter accept # DHCP server & NTP server for LAN
		iifname $LAN tcp dport { node-exporter, zabbix-agent } counter accept # Monitoring agent
		udp dport 51820 ct state new log level notice prefix "New Wireguard connexion: " counter accept 
		tcp dport ssh ct state new log level notice prefix "New SSH connexion: " counter accept
	}
	chain forward {
		type filter hook forward priority filter; policy drop;
		
		ct state invalid counter drop
		ip saddr 192.168.20.20 ip daddr 192.168.1.1 counter accept # Accept from admin to FAI modem
		ip daddr 192.168.1.1 counter reject # Reject any to FAI modem
		ct state { established, related } counter accept
		iifname $WG counter accept # Wireguard Admin VPN to any
		iifname $LAN oifname $WAN counter accept
		iifname $WAN oifname $LAN ip daddr 192.168.10.30 tcp dport 22000 counter accept # Syncthing Port Forwarding
		iifname $WAN oifname $LAN ip daddr 192.168.20.20 tcp dport 8000 counter accept # Temporary web server Port Forwading
		
	}
	chain output {
		type filter hook output priority filter; policy drop;
		ct state invalid counter drop
		oifname "enp1s0" ip daddr 192.168.1.1 counter accept	# Don't Block SSH for ndd
		oifname $WAN ip daddr @RFC1918_3330v4 counter drop 	# Block Leaking Private ip from WAN
		ct state { established, related, new } counter accept
	}
}
table ip sshguard {
	set attackers {
		type ipv4_addr
		flags interval
	}

	chain blacklist {
		type filter hook input priority filter - 10; policy accept;
		ip saddr @attackers drop
	}
}

table ip6 sshguard {
	set attackers {
		type ipv6_addr
		flags interval
	}

	chain blacklist {
		type filter hook input priority filter - 10; policy accept;
		ip6 saddr @attackers drop
	}
}
