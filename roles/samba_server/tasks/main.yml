---
- name: Install samba server
  ansible.builtin.apt:
    name: samba
    state: present
  notify: [Enable smbd service, Start smbd service]

- name: Configure samba server
  ansible.builtin.template:
    src: "smb_{{ inventory_hostname }}.conf.j2"
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  notify: Restart smbd service

- name: Create samba users ( no_log set to true )
  ansible.builtin.user:
    name: "{{ item.username }}"
    create_home: no
    comment: Samba created by Ansible
    password: "!" # Disabled account
    state: present
  loop: "{{ samba_server_users }}"
  no_log: true

- name: Set samba users passwords ( no_log set to true )
  ansible.builtin.shell:
    cmd: "set -o nounset -o pipefail -o errexit && \
      (pdbedit --user={{ item.username }} 2>&1 > /dev/null) \
      || (echo {{ item.password }}; echo {{ item.password }}) \
      | smbpasswd -s -a {{ item.username }}"
    executable: /bin/bash
  loop: "{{ samba_server_users }}"
  register: create_samba_user_output
  changed_when: "'Added user' in create_samba_user_output.stdout"
  no_log: true

- name: Open samba firewalld ports to internal network
  ansible.posix.firewalld:
    zone: "{{ samba_server_firewalld_zone }}"
    rich_rule: "rule family={{ item.family }} source address={{ item.source }} port port={{ item.port }} protocol={{ item.proto }} accept"
    permanent: yes
    immediate: yes
    state: enabled
  loop: "{{ samba_server_firewalld_rich_rules }}"
  when: inventory_hostname == 'laptop'