---
- name: Add Cloudsmith Kea GPG Key
  ansible.builtin.apt_key:
    url: https://dl.cloudsmith.io/public/isc/{{ kea_version }}/{{ cloudsmith_gpg_key }}
    state: present

- name: Add Cloudsmith isc-Kea Debian Repository
  ansible.builtin.apt_repository:
    repo: deb https://dl.cloudsmith.io/public/isc/{{ kea_version }}/deb/debian {{ ansible_distribution_release }}  main
    filename: isc-{{ kea_version }}
    state: present
  notify: ["Apt update", "Apt upgrade"]

- name: Install isc-Kea dhcp server (IPv4 only (for now))
  ansible.builtin.apt:
    name:
      - isc-kea-dhcp4-server
      - isc-kea-admin
      - isc-kea-doc
    update_cache: yes
    state: present
  notify: ["Enable kea-dhcp4 service", "Start kea-dhcp4 service"]

  # TODO: Use the template module to add pools, ip reservations etc...
- name: Configure isc-Kea-dhcp4-server
  ansible.builtin.copy:
    src: kea-dhcp4.conf.json
    dest: /etc/kea/kea-dhcp4.conf
    owner: _kea
    group: _kea
    mode: u=rw,g=,o=
    validate: /usr/sbin/kea-dhcp4 -t %s
  notify: Reload kea-dhcp4 service